/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/. */

#include "eval/evaluator.h"
#include "chess/position.h"
#include "eval/evaluation.h"
#include "utils.h"
#include <stdint.h>

#ifdef __APPLE__
#include <OpenCL/cl.h>
#else
#include <CL/cl.h>
#endif

unsigned char opencl_program[] = {
	0x2f, 0x2f, 0x20, 0x43, 0x6f, 0x6d, 0x70, 0x75, 0x74, 0x65, 0x73, 0x20, 0x74, 0x68,
	0x65, 0x20, 0x4d, 0x61, 0x6e, 0x64, 0x65, 0x6c, 0x62, 0x72, 0x6f, 0x74, 0x20, 0x53,
	0x65, 0x74, 0x20, 0x74, 0x6f, 0x20, 0x4e, 0x20, 0x49, 0x74, 0x65, 0x72, 0x61, 0x74,
	0x69, 0x6f, 0x6e, 0x73, 0x0a, 0x5f, 0x5f, 0x6b, 0x65, 0x72, 0x6e, 0x65, 0x6c, 0x20,
	0x76, 0x6f, 0x69, 0x64, 0x0a, 0x73, 0x6f, 0x6c, 0x76, 0x65, 0x5f, 0x6d, 0x61, 0x6e,
	0x64, 0x65, 0x6c, 0x62, 0x72, 0x6f, 0x74, 0x28, 0x5f, 0x5f, 0x67, 0x6c, 0x6f, 0x62,
	0x61, 0x6c, 0x20, 0x66, 0x6c, 0x6f, 0x61, 0x74, 0x20, 0x63, 0x6f, 0x6e, 0x73, 0x74,
	0x20, 0x2a, 0x72, 0x65, 0x61, 0x6c, 0x2c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5f, 0x5f, 0x67,
	0x6c, 0x6f, 0x62, 0x61, 0x6c, 0x20, 0x66, 0x6c, 0x6f, 0x61, 0x74, 0x20, 0x63, 0x6f,
	0x6e, 0x73, 0x74, 0x20, 0x2a, 0x69, 0x6d, 0x61, 0x67, 0x2c, 0x0a, 0x09, 0x09, 0x09,
	0x09, 0x20, 0x69, 0x6e, 0x74, 0x20, 0x69, 0x74, 0x65, 0x72, 0x61, 0x74, 0x69, 0x6f,
	0x6e, 0x73, 0x2c, 0x0a, 0x09, 0x09, 0x09, 0x09, 0x20, 0x5f, 0x5f, 0x67, 0x6c, 0x6f,
	0x62, 0x61, 0x6c, 0x20, 0x69, 0x6e, 0x74, 0x20, 0x2a, 0x72, 0x65, 0x73, 0x75, 0x6c,
	0x74, 0x29, 0x0a, 0x7b, 0x0a, 0x09, 0x2f, 0x2f, 0x20, 0x47, 0x65, 0x74, 0x20, 0x50,
	0x61, 0x72, 0x61, 0x6c, 0x6c, 0x65, 0x6c, 0x20, 0x49, 0x6e, 0x64, 0x65, 0x78, 0x0a,
	0x09, 0x75, 0x6e, 0x73, 0x69, 0x67, 0x6e, 0x65, 0x64, 0x20, 0x69, 0x6e, 0x74, 0x20,
	0x69, 0x20, 0x3d, 0x20, 0x67, 0x65, 0x74, 0x5f, 0x67, 0x6c, 0x6f, 0x62, 0x61, 0x6c,
	0x5f, 0x69, 0x64, 0x28, 0x30, 0x29, 0x3b, 0x0a, 0x0a, 0x09, 0x66, 0x6c, 0x6f, 0x61,
	0x74, 0x20, 0x78, 0x20, 0x3d, 0x20, 0x72, 0x65, 0x61, 0x6c, 0x5b, 0x69, 0x5d, 0x3b,
	0x20, 0x2f, 0x2f, 0x20, 0x52, 0x65, 0x61, 0x6c, 0x20, 0x43, 0x6f, 0x6d, 0x70, 0x6f,
	0x6e, 0x65, 0x6e, 0x74, 0x0a, 0x09, 0x66, 0x6c, 0x6f, 0x61, 0x74, 0x20, 0x79, 0x20,
	0x3d, 0x20, 0x69, 0x6d, 0x61, 0x67, 0x5b, 0x69, 0x5d, 0x3b, 0x20, 0x2f, 0x2f, 0x20,
	0x49, 0x6d, 0x61, 0x67, 0x69, 0x6e, 0x61, 0x72, 0x79, 0x20, 0x43, 0x6f, 0x6d, 0x70,
	0x6f, 0x6e, 0x65, 0x6e, 0x74, 0x0a, 0x09, 0x69, 0x6e, 0x74, 0x20, 0x20, 0x20, 0x6e,
	0x20, 0x3d, 0x20, 0x30, 0x3b, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x2f,
	0x20, 0x54, 0x72, 0x61, 0x63, 0x6b, 0x73, 0x20, 0x43, 0x6f, 0x6c, 0x6f, 0x72, 0x20,
	0x49, 0x6e, 0x66, 0x6f, 0x72, 0x6d, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x0a, 0x0a, 0x09,
	0x2f, 0x2f, 0x20, 0x43, 0x6f, 0x6d, 0x70, 0x75, 0x74, 0x65, 0x20, 0x74, 0x68, 0x65,
	0x20, 0x4d, 0x61, 0x6e, 0x64, 0x65, 0x6c, 0x62, 0x72, 0x6f, 0x74, 0x20, 0x53, 0x65,
	0x74, 0x0a, 0x09, 0x77, 0x68, 0x69, 0x6c, 0x65, 0x20, 0x28, 0x28, 0x78, 0x20, 0x2a,
	0x20, 0x78, 0x20, 0x2b, 0x20, 0x79, 0x20, 0x2a, 0x20, 0x79, 0x20, 0x3c, 0x3d, 0x20,
	0x32, 0x20, 0x2a, 0x20, 0x32, 0x29, 0x20, 0x26, 0x26, 0x20, 0x6e, 0x20, 0x3c, 0x20,
	0x69, 0x74, 0x65, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x73, 0x29, 0x20, 0x7b, 0x0a,
	0x09, 0x09, 0x66, 0x6c, 0x6f, 0x61, 0x74, 0x20, 0x78, 0x74, 0x65, 0x6d, 0x70, 0x20,
	0x3d, 0x20, 0x78, 0x20, 0x2a, 0x20, 0x78, 0x20, 0x2d, 0x20, 0x79, 0x20, 0x2a, 0x20,
	0x79, 0x20, 0x2b, 0x20, 0x72, 0x65, 0x61, 0x6c, 0x5b, 0x69, 0x5d, 0x3b, 0x0a, 0x09,
	0x09, 0x79, 0x20, 0x3d, 0x20, 0x32, 0x20, 0x2a, 0x20, 0x78, 0x20, 0x2a, 0x20, 0x79,
	0x20, 0x2b, 0x20, 0x69, 0x6d, 0x61, 0x67, 0x5b, 0x69, 0x5d, 0x3b, 0x0a, 0x09, 0x09,
	0x78, 0x20, 0x3d, 0x20, 0x78, 0x74, 0x65, 0x6d, 0x70, 0x3b, 0x0a, 0x09, 0x09, 0x6e,
	0x2b, 0x2b, 0x3b, 0x0a, 0x09, 0x7d, 0x0a, 0x09, 0x2f, 0x2f, 0x20, 0x57, 0x72, 0x69,
	0x74, 0x65, 0x20, 0x52, 0x65, 0x73, 0x75, 0x6c, 0x74, 0x73, 0x20, 0x74, 0x6f, 0x20,
	0x4f, 0x75, 0x74, 0x70, 0x75, 0x74, 0x20, 0x41, 0x72, 0x72, 0x61, 0x79, 0x73, 0x0a,
	0x09, 0x72, 0x65, 0x73, 0x75, 0x6c, 0x74, 0x5b, 0x69, 0x5d, 0x20, 0x3d, 0x20, 0x78,
	0x20, 0x2a, 0x20, 0x78, 0x20, 0x2b, 0x20, 0x79, 0x20, 0x2a, 0x20, 0x79, 0x20, 0x3c,
	0x3d, 0x20, 0x32, 0x20, 0x2a, 0x20, 0x32, 0x20, 0x3f, 0x20, 0x2d, 0x31, 0x20, 0x3a,
	0x20, 0x6e, 0x3b, 0x0a, 0x7d, 0x0a, 0
};

struct Kernels
{
	cl_kernel network_train;
	cl_kernel network_run;
};

struct Evaluator
{
	cl_platform_id platform;
	cl_device_id device;
	cl_context context;
	cl_program program;
	cl_command_queue queue;
	char *error;
	struct Kernels kernels;
};

int
evaluator_init_context(struct Evaluator *evaluator)
{
	cl_context_properties context_properties[2][2] = { 0 };
	context_properties[0][0] = CL_CONTEXT_PLATFORM;
	context_properties[0][1] = evaluator->platform;
	evaluator->context =
	  clCreateContext(context_properties, 1, &evaluator->device, NULL, NULL, NULL);
	return CL_SUCCESS;
}

int
evaluator_init_kernels(struct Evaluator *evaluator)
{
	int error;
	evaluator->kernels.network_train =
	  clCreateKernel(evaluator->program, "network_train", &error);
	evaluator->kernels.network_run =
	  clCreateKernel(evaluator->program, "network_run", &error);
	return error;
}

int
evaluator_init_program(struct Evaluator *evaluator)
{
	int error;
	char *sources[1] = { opencl_program };
	evaluator->program = clCreateProgramWithSource(
	  evaluator->context, 1, sources, NULL, &error);
	clBuildProgram(evaluator->program, 0, NULL, NULL, NULL, NULL);
	return error;
}

struct Evaluator *
evaluator_new(void)
{
	struct Evaluator *evaluator = malloc_or_exit(sizeof(struct Evaluator));
	*evaluator = (struct Evaluator){ 0 };
	clGetPlatformIDs(1, &evaluator->platform, NULL);
	LOGF("Got platform ID");
	switch (clGetDeviceIDs(
	  evaluator->platform, CL_DEVICE_TYPE_ALL, 1, &evaluator->device, NULL)) {
		case CL_SUCCESS:
			break;
		case CL_DEVICE_NOT_FOUND:
			evaluator->error = "Device not found.";
			return evaluator;
		default:
			evaluator->error = "Unexpected error. This is a bug.";
			return evaluator;
	}
	int cl_error = CL_SUCCESS;
	evaluator_init_context(evaluator);
	evaluator_init_program(evaluator);
	evaluator->queue =
	  clCreateCommandQueue(evaluator->context, evaluator->device, 0, &cl_error);
	evaluator_init_kernels(evaluator);
	return evaluator;
}

void
evaluator_delete(struct Evaluator *evaluator)
{
	if (!evaluator) {
		return;
	}
	clReleaseContext(evaluator->context);
	clReleaseProgram(evaluator->program);
	clReleaseCommandQueue(evaluator->queue);
	clReleaseKernel(evaluator->kernels.network_train);
	clReleaseKernel(evaluator->kernels.network_run);
	free(evaluator);
}

int
evaluator_run(struct Evaluator *evaluator,
              struct Position *position,
              struct Evaluation *ptr)
{
	clFinish(evaluator->queue);
	return 0;
}
